# 预约系统功能使用说明

## 功能概览

本系统实现了完整的师生预约功能，包括：
- ✅ 学生创建预约
- ✅ 学生查看预约列表
- ✅ 学生取消预约
- ✅ 老师查看预约列表
- ✅ 老师接受/拒绝预约
- ✅ 查询已预约时间段
- ✅ 防止时间冲突

---

## API 接口详情

### 1. 创建预约
**接口**: `POST /api/schedule/book`  
**权限**: 学生  
**请求体**:
```json
{
  "teacher_id": 2,
  "appointment_date": "2025-10-20",
  "time_slot": "15:00-16:00",
  "appointment_type": "学术咨询",
  "reason": "讨论论文选题"
}
```
**响应示例**:
```json
{
  "message": "预约创建成功",
  "appointment": {
    "id": 1,
    "teacher": {
      "id": 2,
      "name": "李老师"
    },
    "student": {
      "id": 1,
      "name": "张三"
    },
    "appointment_date": "2025-10-20",
    "time_slot": "15:00-16:00",
    "appointment_type": "学术咨询",
    "reason": "讨论论文选题",
    "status": "pending",
    "created_at": "2025-10-14T10:30:00"
  }
}
```

### 2. 查看预约列表
**接口**: `GET /api/schedule/appointments`  
**权限**: 学生/老师  
**查询参数**:
- `status`: 可选，筛选预约状态 (pending/approved/rejected/completed/cancelled)

**响应示例**:
```json
{
  "appointments": [
    {
      "id": 1,
      "teacher": {
        "id": 2,
        "name": "李老师",
        "department": "计算机学院"
      },
      "student": {
        "id": 1,
        "name": "张三"
      },
      "appointment_date": "2025-10-20",
      "time_slot": "15:00-16:00",
      "appointment_type": "学术咨询",
      "reason": "讨论论文选题",
      "status": "pending",
      "created_at": "2025-10-14T10:30:00"
    }
  ]
}
```

### 3. 更新预约状态
**接口**: `PATCH /api/schedule/appointments/<appointment_id>`  
**权限**: 学生/老师  
**请求体**:
```json
{
  "status": "approved"
}
```
**可用状态**:
- 学生: `cancelled` (取消预约)
- 老师: `approved` (接受), `rejected` (拒绝), `completed` (完成)

**响应示例**:
```json
{
  "message": "预约状态更新成功",
  "appointment": {
    "id": 1,
    "status": "approved",
    ...
  }
}
```

### 4. 查询已预约时间段
**接口**: `GET /api/schedule/booked-slots/<teacher_id>`  
**权限**: 无需认证  
**查询参数**:
- `date`: 可选，查询日期 (YYYY-MM-DD格式)，默认为今天

**响应示例**:
```json
{
  "teacher_id": 2,
  "date": "2025-10-20",
  "booked_slots": [
    "15:00-16:00",
    "16:00-17:00"
  ]
}
```

---

## 预约状态说明

| 状态 | 说明 | 谁可以设置 |
|------|------|-----------|
| `pending` | 待处理 | 系统自动设置（创建时） |
| `approved` | 已确认 | 老师 |
| `rejected` | 已拒绝 | 老师 |
| `completed` | 已完成 | 老师 |
| `cancelled` | 已取消 | 学生 |

---

## 业务规则

### 时间冲突检测
- 同一老师同一时间段只能有一个有效预约
- 检测范围：`pending`、`approved` 状态的预约
- 不包括：`rejected`、`cancelled`、`completed` 状态

### 权限控制
1. **学生**:
   - 可以创建预约
   - 可以查看自己的预约
   - 可以取消自己的预约（仅 `cancelled` 状态）
   
2. **老师**:
   - 可以查看所有与自己相关的预约
   - 可以接受/拒绝/完成预约
   - 不能取消预约

### 数据验证
- 预约日期不能是过去的日期
- 时间段格式必须为 `HH:MM-HH:MM`
- 预约类型必须是：学术咨询、课程辅导、项目讨论、其他
- 预约原因必须填写

---

## 前端集成示例

### 学生创建预约
```javascript
async function createAppointment(teacherId, date, timeSlot, type, reason) {
  const response = await fetch('/api/schedule/book', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    },
    body: JSON.stringify({
      teacher_id: teacherId,
      appointment_date: date,
      time_slot: timeSlot,
      appointment_type: type,
      reason: reason
    })
  });
  
  const data = await response.json();
  if (response.ok) {
    alert('预约创建成功！');
    return data.appointment;
  } else {
    alert(`预约失败: ${data.error}`);
  }
}
```

### 学生查看预约
```javascript
async function getMyAppointments() {
  const response = await fetch('/api/schedule/appointments', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    }
  });
  
  const data = await response.json();
  return data.appointments;
}
```

### 老师处理预约
```javascript
async function approveAppointment(appointmentId) {
  const response = await fetch(`/api/schedule/appointments/${appointmentId}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    },
    body: JSON.stringify({ status: 'approved' })
  });
  
  const data = await response.json();
  if (response.ok) {
    alert('预约已接受！');
    return data.appointment;
  } else {
    alert(`操作失败: ${data.error}`);
  }
}
```

### 查询已预约时间段
```javascript
async function getBookedSlots(teacherId, date) {
  const response = await fetch(
    `/api/schedule/booked-slots/${teacherId}?date=${date}`
  );
  
  const data = await response.json();
  return data.booked_slots;
}
```

---

## 数据库表结构

### appointments 表
| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| student_id | Integer | 学生ID（外键） |
| teacher_id | Integer | 老师ID（外键） |
| appointment_date | Date | 预约日期 |
| time_slot | String | 时间段 |
| appointment_type | String | 预约类型 |
| reason | Text | 预约原因 |
| status | String | 状态 |
| created_at | DateTime | 创建时间 |

---

## 测试验证

系统已通过完整的功能测试：

✅ **测试1**: 学生创建预约 - PASSED  
✅ **测试2**: 学生查看预约列表 - PASSED  
✅ **测试3**: 老师查看预约列表 - PASSED  
✅ **测试4**: 老师接受预约 - PASSED  
✅ **测试5**: 老师拒绝预约 - PASSED  
✅ **测试6**: 学生取消预约 - PASSED  
✅ **测试7**: 查询已预约时间段 - PASSED  

所有核心功能均已验证可用！

---

## 常见问题

### Q: 如何防止重复预约？
A: 系统会自动检测时间冲突，同一老师同一时间段只能有一个有效预约。

### Q: 学生可以取消已接受的预约吗？
A: 可以，学生可以取消任何状态的预约（通过设置为 `cancelled`）。

### Q: 老师如何查看待处理的预约？
A: 使用 `GET /api/schedule/appointments?status=pending` 接口。

### Q: 如何标记预约已完成？
A: 老师可以将预约状态设置为 `completed`。

---

## 下一步建议

1. **通知功能**: 
   - 预约创建时通知老师
   - 状态变更时通知学生
   
2. **日历视图**:
   - 可视化显示预约时间表
   - 拖拽式创建预约
   
3. **重复预约**:
   - 支持创建定期预约
   - 批量预约管理
   
4. **统计功能**:
   - 预约数量统计
   - 老师忙碌度分析

---

**最后更新**: 2025-10-14  
**版本**: 1.0.0

