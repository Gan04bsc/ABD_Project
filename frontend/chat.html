<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¸ˆç”Ÿäº’åŠ¨äº¤æµ - Study Abroad</title>
    <link rel="stylesheet" href="./styles/styles.css" />
</head>
<body class="chat-body">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="chat-header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">
                <span>â†</span> è¿”å›æ§åˆ¶å°
            </button>
            <h1 class="page-title">å¸ˆç”Ÿäº’åŠ¨äº¤æµ</h1>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span class="user-role" id="userRole">å­¦ç”Ÿ</span>
                <button class="logout-button" onclick="Auth.signOut(); location.href='index.html'">ç™»å‡º</button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="chat-main-container">
        <!-- ä¾§è¾¹æ  - åŠŸèƒ½å¯¼èˆª -->
        <div class="chat-sidebar">
            <div class="sidebar-section">
                <h3>åŠŸèƒ½å¯¼èˆª</h3>
                <div class="nav-buttons">
                    <button class="nav-button active" onclick="showSection('appointments')">
                        <span class="nav-icon">ğŸ“…</span>
                        é¢„çº¦ç®¡ç†
                    </button>
                    <button class="nav-button" onclick="showSection('chat')">
                        <span class="nav-icon">ğŸ’¬</span>
                        åœ¨çº¿èŠå¤©
                    </button>
                    <button class="nav-button" onclick="showSection('history')">
                        <span class="nav-icon">ğŸ“‹</span>
                        å†å²è®°å½•
                    </button>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>å¿«é€Ÿæ“ä½œ</h3>
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="showNewAppointment()">
                        <span>â•</span> æ–°å»ºé¢„çº¦
                    </button>
                    <button class="quick-action-btn" onclick="refreshData()">
                        <span>ğŸ”„</span> åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="chat-content">
            <!-- é¢„çº¦ç®¡ç†åŒºåŸŸ -->
            <div id="appointments-section" class="content-section active">
                <div class="section-header">
                    <h2>é¢„çº¦ç®¡ç†</h2>
                    <div class="section-actions">
                        <button class="button primary" onclick="showNewAppointment()">
                            <span>â•</span> æ–°å»ºé¢„çº¦
                        </button>
                    </div>
                </div>

                <!-- é¢„çº¦åˆ—è¡¨ -->
                <div class="appointments-container">
                    <div class="appointments-tabs">
                        <button class="tab-button active" onclick="showAppointmentTab('pending')">å¾…å¤„ç†</button>
                        <button class="tab-button" onclick="showAppointmentTab('approved')">å·²ç¡®è®¤</button>
                        <button class="tab-button" onclick="showAppointmentTab('rejected')">å·²æ‹’ç»</button>
                        <button class="tab-button" onclick="showAppointmentTab('completed')">å·²å®Œæˆ</button>
                    </div>

                    <div class="appointments-list" id="appointmentsList">
                        <!-- é¢„çº¦é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>

            <!-- åœ¨çº¿èŠå¤©åŒºåŸŸ -->
            <div id="chat-section" class="content-section">
                <div class="section-header">
                    <h2>åœ¨çº¿èŠå¤©</h2>
                    <div class="chat-status">
                        <span class="status-dot online"></span>
                        <span>åœ¨çº¿</span>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            <div class="message-content">
                                æ¬¢è¿ä½¿ç”¨å¸ˆç”Ÿäº’åŠ¨äº¤æµåŠŸèƒ½ï¼æ‚¨å¯ä»¥é€šè¿‡æ­¤åŠŸèƒ½ä¸è€å¸ˆè¿›è¡Œå®æ—¶æ²Ÿé€šã€‚
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." class="chat-input" />
                        <button class="send-button" onclick="sendMessage()">å‘é€</button>
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div id="history-section" class="content-section">
                <div class="section-header">
                    <h2>å†å²è®°å½•</h2>
                    <div class="filter-controls">
                        <select id="historyFilter" class="filter-select">
                            <option value="all">å…¨éƒ¨è®°å½•</option>
                            <option value="appointments">é¢„çº¦è®°å½•</option>
                            <option value="chat">èŠå¤©è®°å½•</option>
                        </select>
                    </div>
                </div>

                <div class="history-list" id="historyList">
                    <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºé¢„çº¦æ¨¡æ€æ¡† -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºé¢„çº¦ç”³è¯·</h3>
                <button class="close-button" onclick="closeAppointmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="teacherSelect">é€‰æ‹©è€å¸ˆ</label>
                        <select id="teacherSelect" name="teacherSelect" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©è€å¸ˆ</option>
                            <option value="teacher@test.com">å´è€å¸ˆ - æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentDate">é¢„çº¦æ—¥æœŸ</label>
                        <input type="date" id="appointmentDate" name="appointmentDate" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentTime">é¢„çº¦æ—¶é—´</label>
                        <select id="appointmentTime" name="appointmentTime" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©æ—¶é—´</option>
                            <option value="09:00-10:00">09:00-10:00</option>
                            <option value="10:00-11:00">10:00-11:00</option>
                            <option value="11:00-12:00">11:00-12:00</option>
                            <option value="14:00-15:00">14:00-15:00</option>
                            <option value="15:00-16:00">15:00-16:00</option>
                            <option value="16:00-17:00">16:00-17:00</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentType">é¢„çº¦ç±»å‹</label>
                        <select id="appointmentType" name="appointmentType" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="å­¦æœ¯å’¨è¯¢">å­¦æœ¯å’¨è¯¢</option>
                            <option value="èŒä¸šè§„åˆ’">èŒä¸šè§„åˆ’</option>
                            <option value="ç ”ç©¶æŒ‡å¯¼">ç ”ç©¶æŒ‡å¯¼</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentReason">é¢„çº¦åŸå› </label>
                        <textarea id="appointmentReason" name="appointmentReason" class="form-input" rows="4" placeholder="è¯·è¯¦ç»†è¯´æ˜é¢„çº¦åŸå› ..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="button secondary" onclick="closeAppointmentModal()">å–æ¶ˆ</button>
                <button class="button primary" onclick="submitAppointment()">æäº¤é¢„çº¦</button>
            </div>
        </div>
    </div>

    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/chat.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.state.access) {
            window.location.href = 'index.html';
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializeChatPage();
            loadAppointments();
        });

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function initializeChatPage() {
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒå†…å®¹
            const userRole = getUserRole();
            document.getElementById('userRole').textContent = userRole;
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºå½“å‰ç”¨æˆ·ä¿¡æ¯
            console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', {
                role: Auth.state.role,
                userInfo: Auth.state.userInfo,
                userRole: userRole
            });
            
            if (userRole === 'è€å¸ˆ') {
                // è€å¸ˆç«¯æ˜¾ç¤ºé¢„çº¦ç®¡ç†åŠŸèƒ½
                showSection('appointments');
                // éšè—å­¦ç”Ÿç«¯çš„å¿«é€Ÿæ“ä½œ
                document.querySelector('.quick-actions').style.display = 'none';
            } else {
                // å­¦ç”Ÿç«¯æ˜¾ç¤ºèŠå¤©åŠŸèƒ½ï¼Œéšè—é¢„çº¦ç®¡ç†
                showSection('chat');
                // éšè—é¢„çº¦ç®¡ç†ç›¸å…³çš„æŒ‰é’®
                const appointmentSection = document.getElementById('appointments-section');
                if (appointmentSection) {
                    appointmentSection.style.display = 'none';
                }
                // éšè—é¢„çº¦ç®¡ç†å¯¼èˆªæŒ‰é’®
                const appointmentNav = document.querySelector('button[onclick="showSection(\'appointments\')"]');
                if (appointmentNav) {
                    appointmentNav.style.display = 'none';
                }
            }
        }

        function getUserRole() {
            // ä»è®¤è¯çŠ¶æ€ä¸­è·å–ç”¨æˆ·è§’è‰²
            const role = Auth.state.role;
            const userInfo = Auth.state.userInfo;
            
            // å¦‚æœroleä¸ºç©ºï¼Œå°è¯•ä»userInfoä¸­è·å–
            if (!role && userInfo && userInfo.role) {
                return userInfo.role === 'teacher' ? 'è€å¸ˆ' : 'å­¦ç”Ÿ';
            }
            
            if (role === 'teacher') {
                return 'è€å¸ˆ';
            } else {
                return 'å­¦ç”Ÿ';
            }
        }

        function showSection(sectionName) {
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„åŒºåŸŸ
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªæŒ‰é’®
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                if (button.getAttribute('onclick').includes(sectionName)) {
                    button.classList.add('active');
                }
            });
        }

        function showAppointmentTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾ - é€šè¿‡tabNameæ‰¾åˆ°å¯¹åº”æŒ‰é’®
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                if (button.textContent.includes(getTabLabel(tabName))) {
                    button.classList.add('active');
                }
            });
            
            // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
            loadAppointments(tabName);
        }
        
        function getTabLabel(status) {
            const labelMap = {
                'pending': 'å¾…å¤„ç†',
                'approved': 'å·²ç¡®è®¤',
                'rejected': 'å·²æ‹’ç»',
                'completed': 'å·²å®Œæˆ'
            };
            return labelMap[status] || status;
        }

        function loadAppointments(status = 'pending') {
            const appointmentsList = document.getElementById('appointmentsList');
            const userRole = getUserRole();
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½é¢„çº¦æ•°æ®
            let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            
            // å¦‚æœæ²¡æœ‰é¢„çº¦æ•°æ®ï¼Œæ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            if (appointments.length === 0 && userRole === 'è€å¸ˆ') {
                appointments = [
                    {
                        id: 1,
                        teacher: 'å´è€å¸ˆ',
                        subject: 'æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½',
                        date: '2024-01-15',
                        time: '14:00-15:00',
                        type: 'å­¦æœ¯å’¨è¯¢',
                        reason: 'å…³äºæœºå™¨å­¦ä¹ ç®—æ³•çš„ç–‘é—®',
                        status: 'pending',
                        student: {
                            name: 'å¼ ä¸‰',
                            student_id: '2021001',
                            grade: '2021çº§',
                            class_name: 'æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½2021çº§1ç­',
                            email: 'zhangsan@test.com'
                        }
                    },
                    {
                        id: 2,
                        teacher: 'å´è€å¸ˆ',
                        subject: 'æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½',
                        date: '2024-01-16',
                        time: '10:00-11:00',
                        type: 'è¯¾ç¨‹è®¨è®º',
                        reason: 'è®¨è®ºæœŸæœ«é¡¹ç›®æ–¹æ¡ˆ',
                        status: 'approved',
                        student: {
                            name: 'æå››',
                            student_id: '2021002',
                            grade: '2021çº§',
                            class_name: 'æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½2021çº§1ç­',
                            email: 'lisi@test.com'
                        }
                    }
                ];
                localStorage.setItem('appointments', JSON.stringify(appointments));
            }
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºé¢„çº¦æ•°æ®
            console.log('å½“å‰ç”¨æˆ·è§’è‰²:', userRole);
            console.log('æœ¬åœ°å­˜å‚¨çš„é¢„çº¦æ•°æ®:', appointments);
            
            if (userRole === 'è€å¸ˆ') {
                // è€å¸ˆç«¯ï¼šæ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿçš„é¢„çº¦ç”³è¯·
                // ä¸éœ€è¦è¿‡æ»¤ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¢„çº¦
                console.log('è€å¸ˆç«¯ï¼šæ˜¾ç¤ºæ‰€æœ‰é¢„çº¦ç”³è¯·');
            } else {
                // å­¦ç”Ÿç«¯ï¼šä¸æ˜¾ç¤ºé¢„çº¦ç®¡ç†åŠŸèƒ½ï¼Œå­¦ç”Ÿåº”è¯¥é€šè¿‡å…¶ä»–æ–¹å¼å‘èµ·é¢„çº¦
                // å­¦ç”Ÿç«¯ä¸»è¦åŠŸèƒ½æ˜¯å‘èµ·é¢„çº¦ï¼Œè€Œä¸æ˜¯æŸ¥çœ‹é¢„çº¦
                console.log('å­¦ç”Ÿç«¯ï¼šå­¦ç”Ÿä¸åº”è¯¥åœ¨é¢„çº¦ç®¡ç†é¡µé¢æŸ¥çœ‹é¢„çº¦');
                appointments = []; // å­¦ç”Ÿç«¯ä¸æ˜¾ç¤ºé¢„çº¦åˆ—è¡¨
            }

            const filteredAppointments = appointments.filter(apt => apt.status === status);
            
            appointmentsList.innerHTML = filteredAppointments.map(appointment => {
                // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
                let title = '';
                if (userRole === 'è€å¸ˆ') {
                    title = `${appointment.student.name} çš„é¢„çº¦ç”³è¯· - ${appointment.subject}`;
                } else {
                    title = `${appointment.teacher} - ${appointment.subject}`;
                }
                
                return `
                <div class="appointment-card">
                    <div class="appointment-header">
                        <div class="appointment-info">
                            <h4>${title}</h4>
                            <div class="appointment-meta">
                                <span class="appointment-date">ğŸ“… ${appointment.date}</span>
                                <span class="appointment-time">ğŸ• ${appointment.time}</span>
                                <span class="appointment-type">ğŸ“ ${appointment.type}</span>
                            </div>
                        </div>
                        <div class="appointment-status">
                            <span class="status-badge status-${appointment.status}">
                                ${getStatusText(appointment.status)}
                            </span>
                        </div>
                    </div>
                    <div class="appointment-content">
                        <p><strong>é¢„çº¦åŸå› ï¼š</strong>${appointment.reason}</p>
                        ${userRole === 'è€å¸ˆ' ? `
                <div class="student-info">
                    <h5>å­¦ç”Ÿä¿¡æ¯</h5>
                    <div class="student-details">
                        <p><strong>å§“åï¼š</strong>${appointment.student.name || 'æœªè®¾ç½®'}</p>
                        <p><strong>å­¦å·ï¼š</strong>${appointment.student.student_id || 'æœªè®¾ç½®'}</p>
                        <p><strong>å¹´çº§ï¼š</strong>${appointment.student.grade || 'æœªè®¾ç½®'}</p>
                        <p><strong>ç­çº§ï¼š</strong>${appointment.student.class_name || 'æœªè®¾ç½®'}</p>
                        <p><strong>é‚®ç®±ï¼š</strong>${appointment.student.email || 'æœªè®¾ç½®'}</p>
                    </div>
                </div>
                        ` : ''}
                    </div>
                    <div class="appointment-actions">
                        ${getAppointmentActions(appointment.status, appointment.id)}
                    </div>
                </div>
            `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å¤„ç†',
                'approved': 'å·²ç¡®è®¤',
                'completed': 'å·²å®Œæˆ',
                'rejected': 'å·²æ‹’ç»'
            };
            return statusMap[status] || status;
        }

        function getAppointmentActions(status, appointmentId) {
            const userRole = getUserRole();
            
            if (userRole === 'è€å¸ˆ') {
                if (status === 'pending') {
                    return `
                        <button class="button success" onclick="approveAppointment(${appointmentId})">âœ… æ¥å—</button>
                        <button class="button danger" onclick="rejectAppointment(${appointmentId})">âŒ æ‹’ç»</button>
                    `;
                } else if (status === 'approved') {
                    return `
                        <button class="button primary" onclick="completeAppointment(${appointmentId})">âœ… æ ‡è®°å®Œæˆ</button>
                    `;
                } else if (status === 'rejected') {
                    return `
                        <span class="rejected-text">âŒ å·²æ‹’ç»</span>
                    `;
                } else if (status === 'completed') {
                    return `
                        <span class="completed-text">âœ… å·²å®Œæˆ</span>
                    `;
                }
            } else {
                if (status === 'pending') {
                    return `
                        <button class="button secondary" onclick="editAppointment(${appointmentId})">âœï¸ ç¼–è¾‘</button>
                        <button class="button danger" onclick="cancelAppointment(${appointmentId})">âŒ å–æ¶ˆ</button>
                    `;
                } else if (status === 'approved') {
                    return `
                        <span class="approved-text">âœ… å·²ç¡®è®¤</span>
                    `;
                } else if (status === 'rejected') {
                    return `
                        <span class="rejected-text">âŒ å·²æ‹’ç»</span>
                    `;
                } else if (status === 'completed') {
                    return `
                        <span class="completed-text">âœ… å·²å®Œæˆ</span>
                    `;
                }
            }
            
            return '';
        }

        function showNewAppointment() {
            document.getElementById('appointmentModal').style.display = 'flex';
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').style.display = 'none';
            document.getElementById('appointmentForm').reset();
        }

        async function submitAppointment() {
            const form = document.getElementById('appointmentForm');
            const formData = new FormData(form);
            
            // éªŒè¯è¡¨å•
            if (!form.checkValidity()) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            // ä»åç«¯è·å–æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯
            let currentUser = Auth.state.userInfo;
            try {
                const userInfo = await API.get('/api/users/me', {
                    headers: { Authorization: `Bearer ${Auth.state.access}` }
                });
                currentUser = userInfo;
                // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
                Auth.setTokens({ user_info: userInfo });
            } catch (err) {
                console.log('è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯:', err);
            }
            
            const studentInfo = {
                name: currentUser.name || 'æœªè®¾ç½®',
                student_id: currentUser.student_id || 'æœªè®¾ç½®',
                grade: currentUser.grade || 'æœªè®¾ç½®',
                class_name: currentUser.class_name || 'æœªè®¾ç½®',
                email: currentUser.email || 'æœªè®¾ç½®'
            };
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºå­¦ç”Ÿä¿¡æ¯
            console.log('æäº¤é¢„çº¦æ—¶çš„ç”¨æˆ·ä¿¡æ¯:', currentUser);
            console.log('æäº¤é¢„çº¦æ—¶çš„å­¦ç”Ÿä¿¡æ¯:', studentInfo);
            
            // åˆ›å»ºæ–°çš„é¢„çº¦ç”³è¯·
            const newAppointment = {
                id: Date.now(),
                teacher: 'å´è€å¸ˆ',
                subject: 'æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½',
                date: formData.get('appointmentDate'),
                time: formData.get('appointmentTime'),
                type: formData.get('appointmentType'),
                reason: formData.get('appointmentReason'),
                status: 'pending',
                student: studentInfo
            };
            
            // ä¿å­˜é¢„çº¦ç”³è¯·åˆ°æœ¬åœ°å­˜å‚¨
            let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            appointments.push(newAppointment);
            localStorage.setItem('appointments', JSON.stringify(appointments));
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºä¿å­˜çš„é¢„çº¦æ•°æ®
            console.log('ä¿å­˜çš„é¢„çº¦æ•°æ®:', newAppointment);
            console.log('æ‰€æœ‰é¢„çº¦æ•°æ®:', appointments);
            
            alert('é¢„çº¦ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…å´è€å¸ˆç¡®è®¤');
            closeAppointmentModal();
            loadAppointments();
        }

        function approveAppointment(appointmentId) {
            if (confirm('ç¡®è®¤æ¥å—æ­¤é¢„çº¦ç”³è¯·ï¼Ÿ')) {
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]')
                const index = appointments.findIndex(apt => apt.id === appointmentId)
                if (index !== -1) {
                    appointments[index].status = 'approved'
                    localStorage.setItem('appointments', JSON.stringify(appointments))
                    alert('é¢„çº¦å·²ç¡®è®¤')
                    loadAppointments('pending')
                } else {
                    alert('æœªæ‰¾åˆ°è¯¥é¢„çº¦')
                }
            }
        }

        function rejectAppointment(appointmentId) {
            if (confirm('ç¡®è®¤æ‹’ç»æ­¤é¢„çº¦ç”³è¯·ï¼Ÿ')) {
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]')
                const index = appointments.findIndex(apt => apt.id === appointmentId)
                if (index !== -1) {
                    appointments[index].status = 'rejected'
                    localStorage.setItem('appointments', JSON.stringify(appointments))
                    alert('é¢„çº¦å·²æ‹’ç»')
                    loadAppointments('pending')
                } else {
                    alert('æœªæ‰¾åˆ°è¯¥é¢„çº¦')
                }
            }
        }

        function completeAppointment(appointmentId) {
            if (confirm('ç¡®è®¤æ ‡è®°æ­¤é¢„çº¦ä¸ºå·²å®Œæˆï¼Ÿ')) {
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]')
                const index = appointments.findIndex(apt => apt.id === appointmentId)
                if (index !== -1) {
                    appointments[index].status = 'completed'
                    localStorage.setItem('appointments', JSON.stringify(appointments))
                    alert('é¢„çº¦å·²æ ‡è®°ä¸ºå®Œæˆ')
                    loadAppointments('approved')
                } else {
                    alert('æœªæ‰¾åˆ°è¯¥é¢„çº¦')
                }
            }
        }

        function editAppointment(appointmentId) {
            alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...')
        }

        function cancelAppointment(appointmentId) {
            if (confirm('ç¡®è®¤å–æ¶ˆæ­¤é¢„çº¦ï¼Ÿ')) {
                let appointments = JSON.parse(localStorage.getItem('appointments') || '[]')
                const index = appointments.findIndex(apt => apt.id === appointmentId)
                if (index !== -1) {
                    appointments.splice(index, 1)
                    localStorage.setItem('appointments', JSON.stringify(appointments))
                    alert('é¢„çº¦å·²å–æ¶ˆ')
                    loadAppointments('pending')
                } else {
                    alert('æœªæ‰¾åˆ°è¯¥é¢„çº¦')
                }
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            const messagesDiv = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message user';
            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-text">${message}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageElement);
            input.value = '';
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function refreshData() {
            loadAppointments();
            alert('æ•°æ®å·²åˆ·æ–°');
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
