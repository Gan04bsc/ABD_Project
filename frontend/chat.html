<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¸ˆç”Ÿäº’åŠ¨äº¤æµ - é˜¿ä¼¯ä¸ç•™å­¦æœåŠ¡å¹³å°</title>
    <link rel="stylesheet" href="./styles/styles.css" />
</head>
<body class="chat-body">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="chat-header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">
                <span>â†</span> è¿”å›æ§åˆ¶å°
            </button>
            <h1 class="page-title">å¸ˆç”Ÿäº’åŠ¨äº¤æµ</h1>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span class="user-role" id="userRole">å­¦ç”Ÿ</span>
                <button class="logout-button" onclick="Auth.signOut(); location.href='index.html'">ç™»å‡º</button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="chat-main-container">
        <!-- ä¾§è¾¹æ  - åŠŸèƒ½å¯¼èˆª -->
        <div class="chat-sidebar">
            <div class="sidebar-section">
                <h3>åŠŸèƒ½å¯¼èˆª</h3>
                <div class="nav-buttons">
                    <button class="nav-button active" onclick="showSection('appointments')">
                        <span class="nav-icon">ğŸ“…</span>
                        é¢„çº¦ç®¡ç†
                    </button>
                    <button class="nav-button" onclick="showSection('history')">
                        <span class="nav-icon">ğŸ“‹</span>
                        å†å²è®°å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="chat-content">
            <!-- é¢„çº¦ç®¡ç†åŒºåŸŸ -->
            <div id="appointments-section" class="content-section active">
                <div class="section-header">
                    <h2>é¢„çº¦ç®¡ç†</h2>
                    <div class="section-actions">
                        <button id="new-appointment-btn" class="button primary" onclick="showNewAppointment()">
                            <span>â•</span> æ–°å»ºé¢„çº¦
                        </button>
                    </div>
                </div>

                <!-- é¢„çº¦åˆ—è¡¨ -->
                <div class="appointments-container">
                    <div class="appointments-tabs">
                        <button class="tab-button active" onclick="showAppointmentTab('pending')">å¾…å¤„ç†</button>
                        <button class="tab-button" onclick="showAppointmentTab('approved')">å·²ç¡®è®¤</button>
                        <button class="tab-button" onclick="showAppointmentTab('rejected')">å·²æ‹’ç»</button>
                        <button class="tab-button" onclick="showAppointmentTab('completed')">å·²å®Œæˆ</button>
                    </div>

                    <div class="appointments-list" id="appointmentsList">
                        <!-- é¢„çº¦é¡¹ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div id="history-section" class="content-section">
                <div class="section-header">
                    <h2>å†å²è®°å½•</h2>
                    <div class="filter-controls">
                        <select id="historyFilter" class="filter-select" onchange="loadHistory()">
                            <option value="all">å…¨éƒ¨è®°å½•</option>
                            <option value="pending">å¾…å¤„ç†</option>
                            <option value="approved">å·²ç¡®è®¤</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="rejected">å·²æ‹’ç»</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                </div>

                <div class="history-list" id="historyList">
                    <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºé¢„çº¦æ¨¡æ€æ¡† -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºé¢„çº¦ç”³è¯·</h3>
                <button class="close-button" onclick="closeAppointmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="teacherSelect">é€‰æ‹©è€å¸ˆ</label>
                        <select id="teacherSelect" name="teacherSelect" class="form-input" required onchange="updateAvailableSlots()">
                            <option value="">è¯·é€‰æ‹©è€å¸ˆ</option>
                            <option value="teacher@test.com" data-teacher-id="3">å´è€å¸ˆ - æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentDate">é¢„çº¦æ—¥æœŸ</label>
                        <input type="date" id="appointmentDate" name="appointmentDate" class="form-input" required onchange="updateAvailableSlots()">
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentTime">é¢„çº¦æ—¶é—´</label>
                        <select id="appointmentTime" name="appointmentTime" class="form-input" required>
                            <option value="">è¯·å…ˆé€‰æ‹©è€å¸ˆå’Œæ—¥æœŸ</option>
                            <option value="09:00-10:00">09:00-10:00</option>
                            <option value="10:00-11:00">10:00-11:00</option>
                            <option value="11:00-12:00">11:00-12:00</option>
                            <option value="14:00-15:00">14:00-15:00</option>
                            <option value="15:00-16:00">15:00-16:00</option>
                            <option value="16:00-17:00">16:00-17:00</option>
                        </select>
                        <small id="bookedSlotsInfo" style="color: #666; display: block; margin-top: 5px;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentType">é¢„çº¦ç±»å‹</label>
                        <select id="appointmentType" name="appointmentType" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                            <option value="å­¦æœ¯å’¨è¯¢">å­¦æœ¯å’¨è¯¢</option>
                            <option value="èŒä¸šè§„åˆ’">èŒä¸šè§„åˆ’</option>
                            <option value="ç ”ç©¶æŒ‡å¯¼">ç ”ç©¶æŒ‡å¯¼</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="appointmentReason">é¢„çº¦åŸå› </label>
                        <textarea id="appointmentReason" name="appointmentReason" class="form-input" rows="4" placeholder="è¯·è¯¦ç»†è¯´æ˜é¢„çº¦åŸå› ..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="button secondary" onclick="closeAppointmentModal()">å–æ¶ˆ</button>
                <button class="button primary" onclick="submitAppointment()">æäº¤é¢„çº¦</button>
            </div>
        </div>
    </div>

    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/chat.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.state.access) {
            window.location.href = 'index.html';
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializeChatPage();
            loadAppointments();
        });

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function initializeChatPage() {
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒå†…å®¹
            const userRole = getUserRole();
            document.getElementById('userRole').textContent = userRole;
            const newAppointmentBtn = document.getElementById('new-appointment-btn');
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºå½“å‰ç”¨æˆ·ä¿¡æ¯
            console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', {
                role: Auth.state.role,
                userInfo: Auth.state.userInfo,
                userRole: userRole
            });
            
            // é»˜è®¤è¿›å…¥é¢„çº¦ç®¡ç†
            showSection('appointments');

            if (userRole === 'è€å¸ˆ') {
                // è€å¸ˆç«¯ä¸å…è®¸ä¸»åŠ¨æ–°å»ºé¢„çº¦
                if (newAppointmentBtn) {
                    newAppointmentBtn.style.display = 'none';
                }
            } else {
                // å­¦ç”Ÿç«¯å…è®¸æ–°å»ºé¢„çº¦
                if (newAppointmentBtn) {
                    newAppointmentBtn.style.display = 'inline-flex';
                }
            }
        }

        function getUserRole() {
            // ä»è®¤è¯çŠ¶æ€ä¸­è·å–ç”¨æˆ·è§’è‰²
            const role = Auth.state.role;
            const userInfo = Auth.state.userInfo;
            
            // å¦‚æœroleä¸ºç©ºï¼Œå°è¯•ä»userInfoä¸­è·å–
            if (!role && userInfo && userInfo.role) {
                return userInfo.role === 'teacher' ? 'è€å¸ˆ' : 'å­¦ç”Ÿ';
            }
            
            if (role === 'teacher') {
                return 'è€å¸ˆ';
            } else {
                return 'å­¦ç”Ÿ';
            }
        }

        function showSection(sectionName) {
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„åŒºåŸŸ
            document.getElementById(sectionName + '-section').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„å¯¼èˆªæŒ‰é’®
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                if (button.getAttribute('onclick').includes(sectionName)) {
                    button.classList.add('active');
                }
            });
            
            // å¦‚æœåˆ‡æ¢åˆ°å†å²è®°å½•ï¼ŒåŠ è½½æ•°æ®
            if (sectionName === 'history') {
                loadHistory();
            }
        }

        function showAppointmentTab(tabName) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾ - é€šè¿‡tabNameæ‰¾åˆ°å¯¹åº”æŒ‰é’®
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                if (button.textContent.includes(getTabLabel(tabName))) {
                    button.classList.add('active');
                }
            });
            
            // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
            loadAppointments(tabName);
        }
        
        function getTabLabel(status) {
            const labelMap = {
                'pending': 'å¾…å¤„ç†',
                'approved': 'å·²ç¡®è®¤',
                'rejected': 'å·²æ‹’ç»',
                'completed': 'å·²å®Œæˆ'
            };
            return labelMap[status] || status;
        }

        async function loadAppointments(status = 'pending') {
            const appointmentsList = document.getElementById('appointmentsList');
            const userRole = getUserRole();
            
            // ä»åç«¯APIåŠ è½½é¢„çº¦æ•°æ®
            let appointments = [];
            
            try {
                console.log('æ­£åœ¨åŠ è½½é¢„çº¦æ•°æ®ï¼Œtoken:', Auth.state.access ? 'å·²å­˜åœ¨' : 'æœªæ‰¾åˆ°');
                const response = await API.get(`/api/schedule/appointments?status=${status}`, {
                    headers: { 
                        'Authorization': `Bearer ${Auth.state.access}`
                    }
                });
                
                appointments = response.appointments || [];
                console.log('ä»åç«¯åŠ è½½çš„é¢„çº¦æ•°æ®:', appointments);
            } catch (error) {
                console.error('åŠ è½½é¢„çº¦æ•°æ®å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.data);
                
                // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå°è¯•åˆ·æ–°token
                if (error.message && error.message.includes('401')) {
                    console.log('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                }
                
                appointmentsList.innerHTML = `
                    <div class="empty-state">
                        <p>åŠ è½½é¢„çº¦æ•°æ®å¤±è´¥: ${error.message || 'è¯·ç¨åé‡è¯•'}</p>
                    </div>
                `;
                return;
            }

            const filteredAppointments = appointments;
            
            // å¦‚æœæ²¡æœ‰é¢„çº¦æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (filteredAppointments.length === 0) {
                appointmentsList.innerHTML = `
                    <div class="empty-state">
                        <p>æš‚æ— ${getTabLabel(status)}çš„é¢„çº¦</p>
                    </div>
                `;
                return;
            }
            
            appointmentsList.innerHTML = filteredAppointments.map(appointment => {
                // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
                let title = '';
                if (userRole === 'è€å¸ˆ') {
                    title = `${appointment.student?.name || 'æœªçŸ¥å­¦ç”Ÿ'} çš„é¢„çº¦ç”³è¯· - ${appointment.appointment_type}`;
                } else {
                    title = `${appointment.teacher?.name || 'æœªçŸ¥è€å¸ˆ'} - ${appointment.appointment_type}`;
                }
                
                return `
                <div class="appointment-card">
                    <div class="appointment-header">
                        <div class="appointment-info">
                            <h4>${title}</h4>
                            <div class="appointment-meta">
                                <span class="appointment-date">ğŸ“… ${appointment.appointment_date}</span>
                                <span class="appointment-time">ğŸ• ${appointment.time_slot}</span>
                                <span class="appointment-type">ğŸ“ ${appointment.appointment_type}</span>
                            </div>
                        </div>
                        <div class="appointment-status">
                            <span class="status-badge status-${appointment.status}">
                                ${getStatusText(appointment.status)}
                            </span>
                        </div>
                    </div>
                    <div class="appointment-content">
                        <p><strong>é¢„çº¦åŸå› ï¼š</strong>${appointment.reason || 'æ— '}</p>
                        ${userRole === 'è€å¸ˆ' && appointment.student ? `
                <div class="student-info">
                    <h5>å­¦ç”Ÿä¿¡æ¯</h5>
                    <div class="student-details">
                        <p><strong>å§“åï¼š</strong>${appointment.student.name || 'æœªè®¾ç½®'}</p>
                        <p><strong>å­¦å·ï¼š</strong>${appointment.student.student_id || 'æœªè®¾ç½®'}</p>
                        <p><strong>å¹´çº§ï¼š</strong>${appointment.student.grade || 'æœªè®¾ç½®'}</p>
                        <p><strong>ç­çº§ï¼š</strong>${appointment.student.class_name || 'æœªè®¾ç½®'}</p>
                        <p><strong>é‚®ç®±ï¼š</strong>${appointment.student.email || 'æœªè®¾ç½®'}</p>
                    </div>
                </div>
                        ` : ''}
                    </div>
                    <div class="appointment-actions">
                        ${getAppointmentActions(appointment.status, appointment.id)}
                    </div>
                </div>
            `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å¤„ç†',
                'approved': 'å·²ç¡®è®¤',
                'completed': 'å·²å®Œæˆ',
                'rejected': 'å·²æ‹’ç»',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        function getAppointmentActions(status, appointmentId) {
            const userRole = getUserRole();
            
            if (userRole === 'è€å¸ˆ') {
                if (status === 'pending') {
                    return `
                        <button class="button success" onclick="approveAppointment(${appointmentId})">âœ… æ¥å—</button>
                        <button class="button danger" onclick="rejectAppointment(${appointmentId})">âŒ æ‹’ç»</button>
                    `;
                } else if (status === 'approved') {
                    return `
                        <button class="button primary" onclick="completeAppointment(${appointmentId})">âœ… æ ‡è®°å®Œæˆ</button>
                    `;
                } else if (status === 'rejected') {
                    return `
                        <span class="rejected-text">âŒ å·²æ‹’ç»</span>
                    `;
                } else if (status === 'completed') {
                    return `
                        <span class="completed-text">âœ… å·²å®Œæˆ</span>
                    `;
                }
            } else {
                if (status === 'pending') {
                    return `
                        <button class="button secondary" onclick="editAppointment(${appointmentId})">âœï¸ ç¼–è¾‘</button>
                        <button class="button danger" onclick="cancelAppointment(${appointmentId})">âŒ å–æ¶ˆ</button>
                    `;
                } else if (status === 'approved') {
                    return `
                        <span class="approved-text">âœ… å·²ç¡®è®¤</span>
                    `;
                } else if (status === 'rejected') {
                    return `
                        <span class="rejected-text">âŒ å·²æ‹’ç»</span>
                    `;
                } else if (status === 'completed') {
                    return `
                        <span class="completed-text">âœ… å·²å®Œæˆ</span>
                    `;
                } else if (status === 'cancelled') {
                    return `
                        <span class="cancelled-text">ğŸš« å·²å–æ¶ˆ</span>
                    `;
                }
            }
            
            return '';
        }

        function showNewAppointment() {
            if (getUserRole() === 'è€å¸ˆ') {
                alert('è€å¸ˆç«¯ä¸æ”¯æŒæ–°å»ºé¢„çº¦ï¼Œè¯·å¤„ç†å­¦ç”Ÿæäº¤çš„é¢„çº¦ç”³è¯·ã€‚');
                return;
            }
            document.getElementById('appointmentModal').style.display = 'flex';
            // è®¾ç½®æœ€å°æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0]
            document.getElementById('appointmentDate').setAttribute('min', today)
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').style.display = 'none';
            document.getElementById('appointmentForm').reset();
            document.getElementById('bookedSlotsInfo').textContent = ''
        }

        // è·å–å¹¶æ›´æ–°å¯ç”¨æ—¶é—´æ®µ
        async function updateAvailableSlots() {
            const teacherSelect = document.getElementById('teacherSelect')
            const dateInput = document.getElementById('appointmentDate')
            const timeSelect = document.getElementById('appointmentTime')
            const infoElement = document.getElementById('bookedSlotsInfo')
            
            const teacherId = teacherSelect.selectedOptions[0]?.getAttribute('data-teacher-id')
            const selectedDate = dateInput.value
            
            // é‡ç½®æ—¶é—´é€‰æ‹©
            const timeOptions = timeSelect.querySelectorAll('option:not(:first-child)')
            timeOptions.forEach(option => {
                option.disabled = false
                option.style.color = ''
            })
            infoElement.textContent = ''
            
            if (!teacherId || !selectedDate) {
                timeSelect.options[0].text = 'è¯·å…ˆé€‰æ‹©è€å¸ˆå’Œæ—¥æœŸ'
                return
            }
            
            timeSelect.options[0].text = 'è¯·é€‰æ‹©æ—¶é—´'
            
            try {
                const response = await API.get(`/api/schedule/booked-slots/${teacherId}?date=${selectedDate}`)
                const bookedSlots = response.booked_slots || []
                
                if (bookedSlots.length > 0) {
                    infoElement.textContent = `å·²è¢«é¢„çº¦çš„æ—¶é—´æ®µ: ${bookedSlots.join(', ')}`
                    infoElement.style.color = '#e74c3c'
                    
                    // ç¦ç”¨å·²é¢„çº¦çš„æ—¶é—´æ®µ
                    timeOptions.forEach(option => {
                        if (bookedSlots.includes(option.value)) {
                            option.disabled = true
                            option.style.color = '#ccc'
                            option.text = option.value + ' (å·²è¢«é¢„çº¦)'
                        } else {
                            option.text = option.value
                        }
                    })
                } else {
                    infoElement.textContent = 'æ‰€æœ‰æ—¶é—´æ®µå¯ç”¨'
                    infoElement.style.color = '#27ae60'
                }
            } catch (error) {
                console.error('è·å–å·²é¢„çº¦æ—¶é—´æ®µå¤±è´¥:', error)
                infoElement.textContent = 'è·å–æ—¶é—´æ®µä¿¡æ¯å¤±è´¥'
                infoElement.style.color = '#e74c3c'
            }
        }

        async function submitAppointment() {
            const form = document.getElementById('appointmentForm')
            const formData = new FormData(form)
            
            // éªŒè¯è¡¨å•
            if (!form.checkValidity()) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ')
                return
            }
            
            const teacherSelect = document.getElementById('teacherSelect')
            const teacherId = teacherSelect.selectedOptions[0]?.getAttribute('data-teacher-id')
            
            if (!teacherId) {
                alert('è¯·é€‰æ‹©è€å¸ˆ')
                return
            }
            
            // å‡†å¤‡æäº¤æ•°æ®
            const appointmentData = {
                teacher_id: parseInt(teacherId),
                appointment_date: formData.get('appointmentDate'),
                time_slot: formData.get('appointmentTime'),
                appointment_type: formData.get('appointmentType'),
                reason: formData.get('appointmentReason')
            }
            
            try {
                const response = await API.post('/api/schedule/book', appointmentData, {
                    headers: { 
                        'Authorization': `Bearer ${Auth.state.access}`,
                        'Content-Type': 'application/json'
                    }
                })
                
                alert('é¢„çº¦ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…è€å¸ˆç¡®è®¤')
                closeAppointmentModal()
                loadAppointments()
            } catch (error) {
                console.error('æäº¤é¢„çº¦å¤±è´¥:', error)
                if (error.error === 'è¯¥æ—¶é—´æ®µå·²è¢«é¢„çº¦') {
                    alert('è¯¥æ—¶é—´æ®µå·²è¢«å…¶ä»–åŒå­¦é¢„çº¦ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´')
                    updateAvailableSlots() // åˆ·æ–°å¯ç”¨æ—¶é—´æ®µ
                } else {
                    alert(error.error || 'æäº¤é¢„çº¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
                }
            }
        }

        async function approveAppointment(appointmentId) {
            if (confirm('ç¡®è®¤æ¥å—æ­¤é¢„çº¦ç”³è¯·ï¼Ÿ')) {
                try {
                    await API.patch(`/api/schedule/appointments/${appointmentId}`, 
                        { status: 'approved' },
                        {
                            headers: { 
                                'Authorization': `Bearer ${Auth.state.access}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    alert('é¢„çº¦å·²ç¡®è®¤');
                    loadAppointments('pending');
                } catch (error) {
                    console.error('ç¡®è®¤é¢„çº¦å¤±è´¥:', error);
                    alert(error.error || 'ç¡®è®¤é¢„çº¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        }

        async function rejectAppointment(appointmentId) {
            if (confirm('ç¡®è®¤æ‹’ç»æ­¤é¢„çº¦ç”³è¯·ï¼Ÿ')) {
                try {
                    await API.patch(`/api/schedule/appointments/${appointmentId}`, 
                        { status: 'rejected' },
                        {
                            headers: { 
                                'Authorization': `Bearer ${Auth.state.access}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    alert('é¢„çº¦å·²æ‹’ç»');
                    loadAppointments('pending');
                } catch (error) {
                    console.error('æ‹’ç»é¢„çº¦å¤±è´¥:', error);
                    alert(error.error || 'æ‹’ç»é¢„çº¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        }

        async function completeAppointment(appointmentId) {
            if (confirm('ç¡®è®¤æ ‡è®°æ­¤é¢„çº¦ä¸ºå·²å®Œæˆï¼Ÿ')) {
                try {
                    await API.patch(`/api/schedule/appointments/${appointmentId}`, 
                        { status: 'completed' },
                        {
                            headers: { 
                                'Authorization': `Bearer ${Auth.state.access}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    alert('é¢„çº¦å·²æ ‡è®°ä¸ºå®Œæˆ');
                    loadAppointments('approved');
                } catch (error) {
                    console.error('æ ‡è®°å®Œæˆå¤±è´¥:', error);
                    alert(error.error || 'æ ‡è®°å®Œæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        }

        function editAppointment(appointmentId) {
            alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...')
        }

        async function cancelAppointment(appointmentId) {
            if (confirm('ç¡®è®¤å–æ¶ˆæ­¤é¢„çº¦ï¼Ÿ')) {
                try {
                    await API.patch(`/api/schedule/appointments/${appointmentId}`, 
                        { status: 'cancelled' },
                        {
                            headers: { 
                                'Authorization': `Bearer ${Auth.state.access}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    alert('é¢„çº¦å·²å–æ¶ˆ');
                    loadAppointments('pending');
                } catch (error) {
                    console.error('å–æ¶ˆé¢„çº¦å¤±è´¥:', error);
                    alert(error.error || 'å–æ¶ˆé¢„çº¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        }

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            const filterSelect = document.getElementById('historyFilter');
            const filterValue = filterSelect.value;
            const userRole = getUserRole();
            
            historyList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>';
            
            try {
                // æ ¹æ®ç­›é€‰æ¡ä»¶åŠ è½½æ•°æ®
                let url = '/api/schedule/appointments';
                if (filterValue !== 'all') {
                    url += `?status=${filterValue}`;
                }
                
                console.log('åŠ è½½å†å²è®°å½•ï¼ŒURL:', url);
                const response = await API.get(url, {
                    headers: { 
                        'Authorization': `Bearer ${Auth.state.access}`
                    }
                });
                
                let appointments = response.appointments || [];
                console.log('å†å²è®°å½•æ•°æ®:', appointments);
                
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                appointments.sort((a, b) => {
                    const dateA = new Date(a.appointment_date + ' ' + a.time_slot.split('-')[0]);
                    const dateB = new Date(b.appointment_date + ' ' + b.time_slot.split('-')[0]);
                    return dateB - dateA;
                });
                
                if (appointments.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
                            <p style="font-size: 16px; color: #666;">æš‚æ— å†å²è®°å½•</p>
                            <p style="font-size: 14px; color: #999; margin-top: 8px;">æ‚¨çš„é¢„çº¦è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                    `;
                    return;
                }
                
                // æ¸²æŸ“å†å²è®°å½•
                historyList.innerHTML = appointments.map(appointment => {
                    const appointmentDate = new Date(appointment.appointment_date);
                    const now = new Date();
                    const isPast = appointmentDate < now;
                    const isToday = appointmentDate.toDateString() === now.toDateString();
                    
                    let dateLabel = appointment.appointment_date;
                    if (isToday) {
                        dateLabel = 'ä»Šå¤© ' + appointment.appointment_date;
                    } else if (isPast) {
                        dateLabel = appointment.appointment_date + ' (å·²è¿‡æœŸ)';
                    }
                    
                    // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
                    let title = '';
                    let subtitle = '';
                    if (userRole === 'è€å¸ˆ') {
                        title = `ä¸ ${appointment.student?.name || 'æœªçŸ¥å­¦ç”Ÿ'} çš„é¢„çº¦`;
                        subtitle = `å­¦å·: ${appointment.student?.student_id || 'æœªè®¾ç½®'}`;
                    } else {
                        title = `ä¸ ${appointment.teacher?.name || 'æœªçŸ¥è€å¸ˆ'} çš„é¢„çº¦`;
                        subtitle = `é¢„çº¦ç±»å‹: ${appointment.appointment_type}`;
                    }
                    
                    return `
                        <div class="history-card ${isPast ? 'past' : ''}">
                            <div class="history-header">
                                <div class="history-info">
                                    <h4>${title}</h4>
                                    <p class="history-subtitle">${subtitle}</p>
                                </div>
                                <div class="history-status">
                                    <span class="status-badge status-${appointment.status}">
                                        ${getStatusText(appointment.status)}
                                    </span>
                                </div>
                            </div>
                            <div class="history-details">
                                <div class="detail-row">
                                    <span class="detail-icon">ğŸ“…</span>
                                    <span class="detail-label">æ—¥æœŸï¼š</span>
                                    <span class="detail-value">${dateLabel}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-icon">ğŸ•</span>
                                    <span class="detail-label">æ—¶é—´ï¼š</span>
                                    <span class="detail-value">${appointment.time_slot}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-icon">ğŸ“</span>
                                    <span class="detail-label">ç±»å‹ï¼š</span>
                                    <span class="detail-value">${appointment.appointment_type}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-icon">ğŸ’¬</span>
                                    <span class="detail-label">åŸå› ï¼š</span>
                                    <span class="detail-value">${appointment.reason || 'æ— '}</span>
                                </div>
                                ${appointment.created_at ? `
                                <div class="detail-row">
                                    <span class="detail-icon">â°</span>
                                    <span class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</span>
                                    <span class="detail-value">${new Date(appointment.created_at).toLocaleString('zh-CN')}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <p style="font-size: 16px; color: #e74c3c;">åŠ è½½å†å²è®°å½•å¤±è´¥</p>
                        <p style="font-size: 14px; color: #999; margin-top: 8px;">${error.message || 'è¯·ç¨åé‡è¯•'}</p>
                        <button class="button primary" onclick="loadHistory()" style="margin-top: 16px;">é‡æ–°åŠ è½½</button>
                    </div>
                `;
            }
        }

    </script>
</body>
</html>
