<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>留学信息发布 - Study Abroad</title>
    <link rel="stylesheet" href="./styles/styles.css" />
</head>
<body>
    <header>
        <h1>留学信息发布</h1>
        <div>
            <button class="button" onclick="goBack()">返回控制台</button>
            <button class="button" onclick="Auth.signOut(); location.href='index.html'">登出</button>
        </div>
    </header>
    
    <main>
        <section>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h2 style="margin:0;">最新留学信息</h2>
                <button id="open-publish" class="button" style="display:none;" onclick="togglePublish(true)">✍️ 发布信息</button>
            </div>
            <div id="publish-panel" style="display:none; background:#fafafa; border:1px solid #eee; padding:12px; border-radius:8px; margin-top:12px;">
                <div style="display:flex; gap:8px; align-items:center;">
                    <input id="news-title" type="text" placeholder="标题（必填）" style="flex:0 0 280px; padding:8px;">
                    <textarea id="news-content" placeholder="内容（必填）" rows="3" style="flex:1; padding:8px;"></textarea>
                </div>
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <button class="button" onclick="publishNews()">发布</button>
                    <button class="button" onclick="togglePublish(false)">取消</button>
                </div>
            </div>
            <div id="news-list" style="margin-top:12px;"></div>
        </section>
    </main>

    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    <script>
        // 检查登录状态
        if (!Auth.state.access) {
            window.location.href = 'index.html';
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        // 页面加载时获取最新信息
        document.addEventListener('DOMContentLoaded', async function() {
            const isTeacher = Auth.state.role === 'teacher' || (Auth.state.userInfo && Auth.state.userInfo.role === 'teacher');
            if (isTeacher) {
                document.getElementById('open-publish').style.display = 'inline-block';
            }
            await loadNews();
        });

        function togglePublish(show) {
            document.getElementById('publish-panel').style.display = show ? 'block' : 'none';
        }

        async function loadNews() {
            const list = document.getElementById('news-list');
            list.innerHTML = '<div style="padding:12px; color:#666;">加载中...</div>';
            try {
                const items = await API.get('/api/news');
                if (!Array.isArray(items) || items.length === 0) {
                    list.innerHTML = '<div style="padding:24px; color:#888; text-align:center;">暂无信息</div>';
                    return;
                }
                list.innerHTML = items.map(n => `
                    <div class="news-item" style="border: 1px solid #eee; padding: 14px; margin: 10px 0; border-radius: 8px; background:#fff;">
                        <h3 style="margin:0 0 6px;">${escapeHTML(n.title)}</h3>
                        <div style="color:#999; font-size:12px; margin-bottom:8px;">
                            ${n.author_name ? `<span>发布人：${escapeHTML(n.author_name)}</span> · ` : ''}
                            <span>发布于 ${formatDate(n.created_at)}</span>
                            ${n.updated_at && n.updated_at !== n.created_at ? ` · <span>更新于 ${formatDate(n.updated_at)}</span>` : ''}
                        </div>
                        <div style="white-space:pre-wrap; line-height:1.6;">${escapeHTML(n.content)}</div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = `<div style="padding:12px; color:#e74c3c;">加载失败：${err.message || '请稍后重试'}</div>`;
            }
        }

        async function publishNews() {
            const titleEl = document.getElementById('news-title');
            const contentEl = document.getElementById('news-content');
            const title = titleEl.value.trim();
            const content = contentEl.value.trim();
            
            console.log('准备发布:', { title, content });
            
            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }
            
            if (!Auth.state.access) {
                alert('未登录或登录已过期，请重新登录');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                console.log('发送请求到 /api/news');
                const result = await API.post('/api/news', { title, content }, {
                    headers: { Authorization: `Bearer ${Auth.state.access}` },
                });
                console.log('发布成功:', result);
                titleEl.value = '';
                contentEl.value = '';
                togglePublish(false);
                await loadNews();
                alert('发布成功！');
            } catch (err) {
                console.error('发布失败:', err);
                const errorMsg = err.error || err.message || '发布失败，请稍后重试';
                alert('发布失败：' + errorMsg);
            }
        }

        function formatDate(iso) {
            try { return new Date(iso).toLocaleString('zh-CN'); } catch { return iso || ''; }
        }
        function escapeHTML(str) {
            return (str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
    </script>
</body>
</html>

