<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç•™å­¦ä¿¡æ¯å‘å¸ƒ - é˜¿ä¼¯ä¸ç•™å­¦æœåŠ¡å¹³å°</title>
    <link rel="stylesheet" href="./styles/styles.css" />
    <style>
      .news-container {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 96px 24px 24px;
        box-sizing: border-box;
      }

      .news-page {
        background: #ffffff !important;
        min-height: 100vh;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
      }

      .toolbar-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .news-top-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }

      .top-back-button {
        padding: 8px 14px;
        background: #f1f4fb;
        border: 1px solid #dbe3f5;
        border-radius: 18px;
        cursor: pointer;
        font-size: 13px;
        color: #4b5f86;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .top-back-button:hover {
        background: #e7eefc;
      }

      .news-top-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        color: #1d2538;
        pointer-events: none;
      }

      .back-button {
        padding: 10px 20px;
        background: #f5f5f5;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        transition: all 0.2s;
      }

      .back-button:hover {
        background: #e0e0e0;
      }

      .tools-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .search-bar {
        flex: 1;
      }

      .search-input {
        width: 100%;
        padding: 12px 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .publish-panel {
        display: none;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .publish-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .publish-title,
      .publish-content {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        font-family: inherit;
      }

      .publish-content {
        min-height: 110px;
        resize: vertical;
      }

      .publish-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      .news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
        gap: 16px;
      }

      .news-card {
        background: white;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 18px;
        transition: all 0.2s;
      }

      .news-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }

      .news-title {
        margin: 0 0 8px;
        font-size: 20px;
        font-weight: 600;
        color: #1a1a1a;
        line-height: 1.35;
      }

      .news-meta {
        font-size: 12px;
        color: #888;
        margin-bottom: 12px;
        line-height: 1.5;
      }

      .news-content {
        color: #444;
        line-height: 1.75;
        font-size: 14px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
        border: 1px dashed #ddd;
        border-radius: 12px;
        background: #fafafa;
      }

      .empty-state-icon {
        font-size: 42px;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #888;
      }

      @media (max-width: 768px) {
        .news-container {
          padding: 92px 14px 14px;
        }

        .page-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .tools-row {
          flex-direction: column;
          align-items: stretch;
        }

        .news-grid {
          grid-template-columns: 1fr;
        }

        .news-top-title {
          font-size: 22px;
        }
      }
    </style>
</head>
<body class="dashboard-body news-page">
    <div class="header-bar">
      <div class="news-top-left">
        <button class="top-back-button" onclick="goBack()">â† è¿”å›ä¸»é¡µ</button>
        <div class="logo">A</div>
        <h1 class="header-title">åå—å¸ˆèŒƒå¤§å­¦é˜¿ä¼¯ä¸ æ•°æ®ç§‘å­¦ä¸äººå·¥æ™ºèƒ½å­¦é™¢</h1>
      </div>
      <h1 class="news-top-title">ç•™å­¦ä¿¡æ¯å‘å¸ƒ</h1>
      <div class="header-actions">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">U</div>
          <span id="username">ç”¨æˆ·</span>
        </div>
      </div>
    </div>

    <div class="news-container">
      <div class="tools-row">
        <div class="search-bar">
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢æ ‡é¢˜ã€å†…å®¹ã€å‘å¸ƒäºº..." />
        </div>
        <button id="open-publish" class="button" style="display:none;" onclick="togglePublish(true)">âœï¸ å‘å¸ƒä¿¡æ¯</button>
      </div>

      <div id="publish-panel" class="publish-panel">
        <div class="publish-form">
          <input id="news-title" class="publish-title" type="text" placeholder="æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" />
          <textarea id="news-content" class="publish-content" placeholder="å†…å®¹ï¼ˆå¿…å¡«ï¼‰"></textarea>
          <div class="publish-actions">
            <button class="button" onclick="togglePublish(false)">å–æ¶ˆ</button>
            <button class="button" onclick="publishNews()">å‘å¸ƒ</button>
          </div>
        </div>
      </div>

      <div id="news-list" class="loading">åŠ è½½ä¸­...</div>
    </div>

    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    <script>
      let allNews = [];

      document.addEventListener('DOMContentLoaded', async function() {
        try {
          await Auth.checkAuth();
        } catch (err) {
          alert('è¯·å…ˆç™»å½•');
          location.href = 'index.html';
          return;
        }

        updateHeaderUser();

        const isTeacher = Auth.state.role === 'teacher' || (Auth.state.userInfo && Auth.state.userInfo.role === 'teacher');
        if (isTeacher) {
          document.getElementById('open-publish').style.display = 'inline-flex';
        }

        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', handleSearch);

        await loadNews();
      });

      function goBack() {
        location.href = 'dashboard.html';
      }

      function updateHeaderUser() {
        const user = Auth.state.user || Auth.state.userInfo || {};
        const name = user.name || user.email || (Auth.state.role === 'teacher' ? 'æ•™å¸ˆ' : 'ç”¨æˆ·');
        const username = document.getElementById('username');
        const avatar = document.getElementById('user-avatar');
        if (username) username.textContent = name;
        if (avatar) avatar.textContent = name.charAt(0).toUpperCase();
      }

      function togglePublish(show) {
        document.getElementById('publish-panel').style.display = show ? 'block' : 'none';
      }

      async function loadNews() {
        const list = document.getElementById('news-list');
        list.className = 'loading';
        list.innerHTML = 'åŠ è½½ä¸­...';

        try {
          const items = await API.get('/api/news');
          allNews = Array.isArray(items) ? items : [];
          renderNews(allNews);
        } catch (err) {
          list.className = '';
          list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div>åŠ è½½å¤±è´¥ï¼š${escapeHTML(err.message || 'è¯·ç¨åé‡è¯•')}</div></div>`;
        }
      }

      function handleSearch(e) {
        const keyword = (e.target.value || '').toLowerCase().trim();
        if (!keyword) {
          renderNews(allNews);
          return;
        }

        const filtered = allNews.filter((item) => {
          const title = (item.title || '').toLowerCase();
          const content = (item.content || '').toLowerCase();
          const author = (item.author_name || '').toLowerCase();
          return title.includes(keyword) || content.includes(keyword) || author.includes(keyword);
        });

        renderNews(filtered);
      }

      function renderNews(items) {
        const list = document.getElementById('news-list');

        if (!items || items.length === 0) {
          list.className = '';
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“°</div>
              <div>æš‚æ— ç¬¦åˆæ¡ä»¶çš„ç•™å­¦ä¿¡æ¯</div>
            </div>
          `;
          return;
        }

        list.className = 'news-grid';
        list.innerHTML = items.map((n) => `
          <article class="news-card">
            <h3 class="news-title">${escapeHTML(n.title)}</h3>
            <div class="news-meta">
              ${n.author_name ? `<span>å‘å¸ƒäººï¼š${escapeHTML(n.author_name)}</span> Â· ` : ''}
              <span>å‘å¸ƒäº ${formatDate(n.created_at)}</span>
              ${n.updated_at && n.updated_at !== n.created_at ? ` Â· <span>æ›´æ–°äº ${formatDate(n.updated_at)}</span>` : ''}
            </div>
            <div class="news-content">${escapeHTML(n.content)}</div>
          </article>
        `).join('');
      }

      async function publishNews() {
        const titleEl = document.getElementById('news-title');
        const contentEl = document.getElementById('news-content');
        const title = titleEl.value.trim();
        const content = contentEl.value.trim();

        if (!title || !content) {
          alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
          return;
        }

        try {
          await API.post('/api/news', { title, content }, {
            headers: { Authorization: `Bearer ${Auth.state.access}` },
          });
          titleEl.value = '';
          contentEl.value = '';
          togglePublish(false);
          await loadNews();
          const searchInput = document.getElementById('search-input');
          if (searchInput && searchInput.value.trim()) {
            handleSearch({ target: searchInput });
          }
          alert('å‘å¸ƒæˆåŠŸ');
        } catch (err) {
          alert('å‘å¸ƒå¤±è´¥ï¼š' + (err.error || err.message || 'è¯·ç¨åé‡è¯•'));
        }
      }

      function formatDate(iso) {
        try {
          return new Date(iso).toLocaleString('zh-CN');
        } catch {
          return iso || '';
        }
      }

      function escapeHTML(str) {
        return (str || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
    </script>
</body>
</html>
