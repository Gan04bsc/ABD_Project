<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>个人资料与文档管理</title>
    <link rel="stylesheet" href="./styles/styles.css" />
    <style>
      .profile-page {
        background: #fff;
      }

      .profile-container {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 96px 24px 24px;
        box-sizing: border-box;
      }

      .top-back-button {
        padding: 8px 14px;
        background: #f1f4fb;
        border: 1px solid #dbe3f5;
        border-radius: 18px;
        cursor: pointer;
        font-size: 13px;
        color: #4b5f86;
        transition: all 0.2s;
      }

      .top-back-button:hover {
        background: #e7eefc;
      }

      .profile-section {
        background: #fff;
        border: 1px solid #e8edf7;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 18px;
      }

      .profile-section h2 {
        margin: 0 0 16px;
      }

      .upload-area {
        border: 2px dashed #d7deef;
        border-radius: 10px;
        padding: 18px;
        text-align: center;
        margin-bottom: 16px;
        background: #fafcff;
      }

      .file-item {
        border: 1px solid #e8edf7;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .file-main {
        min-width: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .file-title {
        color: #1f4fa6;
        cursor: pointer;
        font-weight: 600;
      }

      .file-meta {
        font-size: 12px;
        color: #6c7a95;
      }

      .file-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .status-line {
        margin-top: 8px;
        font-size: 13px;
        color: #6c7a95;
      }
    </style>
  </head>
  <body class="dashboard-body profile-page">
    <div class="header-bar">
      <div class="logo-section">
        <button class="top-back-button" onclick="window.location.href='dashboard.html'">返回主页</button>
        <div class="logo">A</div>
        <h1 class="header-title">个人资料与文档管理</h1>
      </div>
      <div class="header-actions">
        <div class="user-info">
          <div class="user-avatar" id="profile-avatar">U</div>
          <span id="profile-username">用户</span>
        </div>
      </div>
    </div>

    <main class="profile-container">
      <section class="profile-section">
        <h2>个人基础信息</h2>
        <form id="profile-form">
          <div>
            <label for="name">姓名</label>
            <input type="text" id="name" name="name" required />
          </div>
          <div>
            <label for="student_id">学号</label>
            <input type="text" id="student_id" name="student_id" />
          </div>
          <div>
            <label for="grade">年级</label>
            <input type="text" id="grade" name="grade" />
          </div>
          <div>
            <label for="class_name">班级</label>
            <input type="text" id="class_name" name="class_name" />
          </div>
          <div style="margin-top: 18px; display:flex; gap:10px;">
            <button type="submit" class="button">保存资料</button>
            <button type="button" class="button" id="reload-profile">重新加载</button>
          </div>
          <div class="status-line" id="profile-status"></div>
        </form>
      </section>

      <section class="profile-section">
        <h2>文件管理</h2>
        <div class="upload-area">
          <input
            type="file"
            id="file-input"
            multiple
            style="display:none;"
            accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.ppt,.pptx"
          />
          <button class="button" type="button" id="pick-files">选择文件上传</button>
          <p style="margin:10px 0 0;color:#6c7a95;">支持 Word/PDF/图片/Excel/PPT</p>
        </div>
        <div class="status-line" id="files-status">正在加载文件...</div>
        <div id="file-list"></div>
      </section>
    </main>

    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    <script>
      const profileState = {
        me: null,
        documents: [],
      };

      function authHeaders() {
        return { Authorization: `Bearer ${Auth.state.access}` };
      }

      function escapeHtml(v) {
        const div = document.createElement("div");
        div.textContent = v == null ? "" : String(v);
        return div.innerHTML;
      }

      function getFileIcon(ext) {
        const key = String(ext || "").toLowerCase();
        if (["png", "jpg", "jpeg", "gif", "bmp", "webp"].includes(key)) return "🖼";
        if (["pdf"].includes(key)) return "📄";
        if (["doc", "docx"].includes(key)) return "📝";
        if (["xls", "xlsx"].includes(key)) return "📊";
        if (["ppt", "pptx"].includes(key)) return "📽";
        return "📁";
      }

      function formatFileSize(bytes) {
        if (!bytes) return "0 B";
        const units = ["B", "KB", "MB", "GB"];
        let n = bytes;
        let i = 0;
        while (n >= 1024 && i < units.length - 1) {
          n /= 1024;
          i += 1;
        }
        return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
      }

      function formatDateTime(value) {
        if (!value) return "-";
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return "-";
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
      }

      function setProfileStatus(text, isError = false) {
        const el = document.getElementById("profile-status");
        if (!el) return;
        el.textContent = text || "";
        el.style.color = isError ? "#d32f2f" : "#6c7a95";
      }

      function setFilesStatus(text, isError = false) {
        const el = document.getElementById("files-status");
        if (!el) return;
        el.textContent = text || "";
        el.style.color = isError ? "#d32f2f" : "#6c7a95";
      }

      function renderProfile(profile) {
        document.getElementById("name").value = profile.name || "";
        document.getElementById("student_id").value = profile.student_id || "";
        document.getElementById("grade").value = profile.grade || "";
        document.getElementById("class_name").value = profile.class_name || "";

        const displayName = profile.name || profile.email || "用户";
        const usernameEl = document.getElementById("profile-username");
        const avatarEl = document.getElementById("profile-avatar");
        if (usernameEl) usernameEl.textContent = displayName;
        if (avatarEl) avatarEl.textContent = String(displayName).charAt(0).toUpperCase();
      }

      function renderFiles() {
        const listEl = document.getElementById("file-list");
        if (!listEl) return;

        if (!profileState.documents.length) {
          listEl.innerHTML = '<p style="color:#6c7a95;">暂无文件</p>';
          return;
        }

        listEl.innerHTML = profileState.documents
          .map((file) => {
            return `
              <div class="file-item" data-id="${file.id}">
                <div class="file-main">
                  <span style="font-size:20px;">${getFileIcon(file.file_type)}</span>
                  <div style="min-width:0;">
                    <div class="file-title" data-action="view" data-id="${file.id}">${escapeHtml(file.name || "未命名文件")}</div>
                    <div class="file-meta">${escapeHtml(file.file_type || "-")} · ${escapeHtml(formatFileSize(file.file_size))} · ${escapeHtml(formatDateTime(file.created_at))}</div>
                  </div>
                </div>
                <div class="file-actions">
                  <button class="button" type="button" data-action="view" data-id="${file.id}">查看</button>
                  <button class="button" type="button" data-action="download" data-id="${file.id}">下载</button>
                  <button class="button" type="button" data-action="delete" data-id="${file.id}" style="background:#dc3545;">删除</button>
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function loadProfile() {
        const profile = await API.get(`/api/users/profile?t=${Date.now()}`, {
          headers: { ...authHeaders(), "Cache-Control": "no-cache" },
        });
        profileState.me = profile;
        renderProfile(profile);
      }

      async function loadFiles() {
        const docs = await API.get("/api/documents", { headers: authHeaders() });
        profileState.documents = Array.isArray(docs) ? docs : [];
        renderFiles();
      }

      async function saveProfile(event) {
        event.preventDefault();
        setProfileStatus("正在保存...");

        const form = document.getElementById("profile-form");
        const payload = {
          name: form.name.value.trim(),
          student_id: form.student_id.value.trim(),
          grade: form.grade.value.trim(),
          class_name: form.class_name.value.trim(),
        };

        try {
          await API.put("/api/users/profile", payload, { headers: authHeaders() });
          setProfileStatus("保存成功");
          await loadProfile();
        } catch (error) {
          setProfileStatus(`保存失败: ${error.message || error}`, true);
        }
      }

      async function uploadSelectedFiles() {
        const input = document.getElementById("file-input");
        if (!input.files || !input.files.length) return;

        setFilesStatus("正在上传...");

        for (const file of input.files) {
          const formData = new FormData();
          formData.append("file", file);

          const response = await fetch(`${API.baseURL}/api/documents`, {
            method: "POST",
            headers: authHeaders(),
            body: formData,
          });

          if (response.status === 401) {
            await Auth.refresh();
            return uploadSelectedFiles();
          }

          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.message || `${file.name} 上传失败`);
          }
        }

        input.value = "";
        setFilesStatus("上传成功");
        await loadFiles();
      }

      async function openFile(fileId, mode) {
        const endpoint = mode === "download" ? `/api/documents/${fileId}/download` : `/api/documents/${fileId}/view`;
        const response = await fetch(`${API.baseURL}${endpoint}`, {
          method: "GET",
          headers: authHeaders(),
        });

        if (response.status === 401) {
          await Auth.refresh();
          return openFile(fileId, mode);
        }

        if (!response.ok) {
          throw new Error(`操作失败: ${response.status}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        if (mode === "download") {
          const a = document.createElement("a");
          a.href = url;
          a.download = "document";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => window.URL.revokeObjectURL(url), 3000);
        } else {
          window.open(url, "_blank", "noopener");
          setTimeout(() => window.URL.revokeObjectURL(url), 60000);
        }
      }

      async function deleteFile(fileId) {
        if (!window.confirm("确定要删除这个文件吗？")) return;

        const response = await fetch(`${API.baseURL}/api/documents/${fileId}`, {
          method: "DELETE",
          headers: authHeaders(),
        });

        if (response.status === 401) {
          await Auth.refresh();
          return deleteFile(fileId);
        }

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.message || "删除失败");
        }

        await loadFiles();
      }

      function bindEvents() {
        document.getElementById("profile-form").addEventListener("submit", saveProfile);
        document.getElementById("reload-profile").addEventListener("click", async () => {
          try {
            setProfileStatus("重新加载中...");
            await loadProfile();
            setProfileStatus("已刷新");
          } catch (error) {
            setProfileStatus(`加载失败: ${error.message || error}`, true);
          }
        });

        document.getElementById("pick-files").addEventListener("click", () => {
          document.getElementById("file-input").click();
        });

        document.getElementById("file-input").addEventListener("change", async () => {
          try {
            await uploadSelectedFiles();
          } catch (error) {
            setFilesStatus(`上传失败: ${error.message || error}`, true);
          }
        });

        document.getElementById("file-list").addEventListener("click", async (event) => {
          const btn = event.target.closest("[data-action][data-id]");
          if (!btn) return;

          const action = btn.dataset.action;
          const fileId = Number(btn.dataset.id);
          if (!fileId) return;

          try {
            if (action === "view") {
              await openFile(fileId, "view");
            } else if (action === "download") {
              await openFile(fileId, "download");
            } else if (action === "delete") {
              await deleteFile(fileId);
            }
          } catch (error) {
            setFilesStatus(`操作失败: ${error.message || error}`, true);
          }
        });
      }

      async function initPage() {
        if (!Auth.state.access) {
          window.location.href = "index.html";
          return;
        }

        try {
          await Auth.checkAuth();
          bindEvents();
          await Promise.all([loadProfile(), loadFiles()]);
          setProfileStatus("");
          setFilesStatus("");
        } catch (error) {
          console.error("初始化失败:", error);
          window.location.href = "index.html";
        }
      }

      document.addEventListener("DOMContentLoaded", initPage);
    </script>
  </body>
</html>
