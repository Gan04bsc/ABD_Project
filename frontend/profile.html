<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä¸ªäººèµ„æ–™ç®¡ç† - Study Abroad</title>
    <link rel="stylesheet" href="./styles/styles.css" />
</head>
<body>
    <header>
        <h1>ä¸ªäººèµ„æ–™ç®¡ç†</h1>
        <div>
            <button class="button" onclick="goBack()">è¿”å›æ§åˆ¶å°</button>
            <button class="button" onclick="Auth.signOut(); location.href='index.html'">ç™»å‡º</button>
        </div>
    </header>
    
    <main>
        <section>
            <h2>ç¼–è¾‘ä¸ªäººèµ„æ–™</h2>
            <form id="profile-form" onsubmit="return saveProfile(event)">
                <div>
                    <label for="name">å§“åï¼š</label>
                    <input type="text" id="name" name="name" required />
                </div>
                <div>
                    <label for="student_id">å­¦å·ï¼š</label>
                    <input type="text" id="student_id" name="student_id" />
                </div>
                <div>
                    <label for="grade">å¹´çº§ï¼š</label>
                    <input type="text" id="grade" name="grade" />
                </div>
                <div>
                    <label for="class_name">ç­çº§ï¼š</label>
                    <input type="text" id="class_name" name="class_name" />
                </div>
                <div style="margin: 20px 0;">
                    <button type="submit" class="button" style="padding: 10px 20px;">ä¿å­˜èµ„æ–™</button>
                    <button type="button" class="button" onclick="loadProfile()" style="padding: 10px 20px; margin-left: 10px;">é‡æ–°åŠ è½½</button>
                </div>
            </form>
        </section>

        <section style="margin-top: 40px;">
            <h2>æ–‡ä»¶ç®¡ç†</h2>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-area" style="border: 2px dashed #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; text-align: center;">
                <input type="file" id="file-input" multiple style="display: none;" accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.xls,.xlsx,.ppt,.pptx" />
                <button class="button" onclick="document.getElementById('file-input').click()" style="padding: 10px 20px;">
                    é€‰æ‹©æ–‡ä»¶ä¸Šä¼ 
                </button>
                <p style="margin: 10px 0; color: #666;">
                    æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼šWordã€PDFã€å›¾ç‰‡ã€Excelã€PowerPointç­‰
                </p>
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div id="file-list" style="margin-top: 20px;">
                <div id="file-list-content">
                    <p>æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
                </div>
            </div>
        </section>
    </main>

    <script src="./js/api.js"></script>
    <script src="./js/auth.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!Auth.state.access) {
            window.location.href = 'index.html';
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        // åŠ è½½ç”¨æˆ·èµ„æ–™
        async function loadProfile() {
            try {
                console.log('å¼€å§‹åŠ è½½ç”¨æˆ·èµ„æ–™...');
                const data = await API.get(`/api/users/profile?t=${Date.now()}`, { 
                    headers: { 'Cache-Control': 'no-cache', Authorization: `Bearer ${Auth.state.access}` } 
                });
                console.log('è·å–åˆ°çš„ç”¨æˆ·èµ„æ–™:', data);
                
                document.getElementById('name').value = data.name || '';
                document.getElementById('student_id').value = data.student_id || '';
                document.getElementById('grade').value = data.grade || '';
                document.getElementById('class_name').value = data.class_name || '';
                
                console.log('ç”¨æˆ·èµ„æ–™åŠ è½½å®Œæˆ');
            } catch (err) {
                // 401 åˆ·æ–° token åé‡è¯•ä¸€æ¬¡
                if (err?.status === 401) {
                    await Auth.refresh();
                    return loadProfile();
                }
                console.error('åŠ è½½èµ„æ–™å¤±è´¥:', err);
                alert('åŠ è½½èµ„æ–™å¤±è´¥ï¼š' + (err?.message || err));
            }
        }

        // ä¿å­˜ç”¨æˆ·èµ„æ–™
        async function saveProfile(e) {
            e?.preventDefault?.();
            const form = document.getElementById('profile-form');
            const body = {
                name: form.name.value.trim(),
                student_id: form.student_id.value.trim(),
                grade: form.grade.value.trim(),
                class_name: form.class_name.value.trim(),
            };
            console.log('å‡†å¤‡ä¿å­˜ç”¨æˆ·èµ„æ–™:', body);
            
            try {
                const resp = await API.put('/api/users/profile', body, {
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${Auth.state.access}` }
                });
                console.log('ä¿å­˜æˆåŠŸï¼ŒæœåŠ¡å™¨å“åº”:', resp);
                alert('ä¿å­˜æˆåŠŸ');
            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                // access è¿‡æœŸåˆ™åˆ·æ–°åé‡è¯•ä¸€æ¬¡
                try {
                    await Auth.refresh();
                    const resp2 = await API.put('/api/users/profile', body, {
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${Auth.state.access}` }
                    });
                    console.log('ä¿å­˜æˆåŠŸï¼ŒæœåŠ¡å™¨å“åº”:', resp2);
                    alert('ä¿å­˜æˆåŠŸ');
                } catch (e) {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (e?.message || e));
                }
            }
            return false;
        }

        // æ–‡ä»¶ç®¡ç†åŠŸèƒ½
        let files = [];

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles() {
            try {
                const response = await API.get('/api/documents', {
                    headers: { Authorization: `Bearer ${Auth.state.access}` }
                });
                files = response;
                renderFileList();
            } catch (err) {
                if (err?.status === 401) {
                    await Auth.refresh();
                    return loadFiles();
                }
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', err);
                document.getElementById('file-list-content').innerHTML = 
                    `<p style="color: red;">åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š${err?.message || err}</p>`;
            }
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            const container = document.getElementById('file-list-content');
            
            if (files.length === 0) {
                container.innerHTML = '<p style="color: #666;">æš‚æ— æ–‡ä»¶</p>';
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="file-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="file-icon" style="font-size: 24px;">${getFileIcon(file.file_type)}</span>
                            <div>
                                <div class="file-name" style="font-weight: 500; cursor: pointer; color: #007bff;" data-file-id="${file.id}" onclick="viewFile(${file.id})" title="ç‚¹å‡»æŸ¥çœ‹æ–‡ä»¶">
                                    ${file.name}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ${formatFileSize(file.file_size)} â€¢ ${file.file_type.toUpperCase()} â€¢ 
                                    ${new Date(file.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="button view-btn" data-file-id="${file.id}" style="padding: 5px 10px; font-size: 12px; background: #17a2b8;">æŸ¥çœ‹</button>
                        <button class="button download-btn" data-file-id="${file.id}" style="padding: 5px 10px; font-size: 12px;">ä¸‹è½½</button>
                        <button class="button rename-btn" data-file-id="${file.id}" data-file-name="${file.name.replace(/"/g, '&quot;')}" style="padding: 5px 10px; font-size: 12px; background: #28a745;">é‡å‘½å</button>
                        <button class="button delete-btn" data-file-id="${file.id}" style="padding: 5px 10px; font-size: 12px; background: #dc3545;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            addFileEventListeners();
        }
        
        // æ·»åŠ æ–‡ä»¶æ“ä½œäº‹ä»¶ç›‘å¬å™¨
        function addFileEventListeners() {
            // æŸ¥çœ‹æŒ‰é’®
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileId = parseInt(e.target.getAttribute('data-file-id'));
                    viewFile(fileId);
                });
            });
            
            // ä¸‹è½½æŒ‰é’®
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileId = parseInt(e.target.getAttribute('data-file-id'));
                    downloadFile(fileId);
                });
            });
            
            // é‡å‘½åæŒ‰é’®
            document.querySelectorAll('.rename-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileId = parseInt(e.target.getAttribute('data-file-id'));
                    const fileName = e.target.getAttribute('data-file-name');
                    renameFile(fileId, fileName);
                });
            });
            
            // åˆ é™¤æŒ‰é’®
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileId = parseInt(e.target.getAttribute('data-file-id'));
                    deleteFile(fileId);
                });
            });
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'ğŸ“„',
                'doc': 'ğŸ“', 'docx': 'ğŸ“',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
                'ppt': 'ğŸ“Š', 'pptx': 'ğŸ“Š',
                'png': 'ğŸ–¼ï¸', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                'txt': 'ğŸ“„'
            };
            return icons[fileType] || 'ğŸ“„';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFiles() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            if (files.length === 0) return;

            for (let file of files) {
                await uploadSingleFile(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            fileInput.value = '';
            // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            await loadFiles();
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        async function uploadSingleFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Auth.state.access}`
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message);
                }

                console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result);
            } catch (err) {
                console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', err);
                alert(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥ï¼š${err.message}`);
            }
        }

        // æŸ¥çœ‹æ–‡ä»¶ï¼ˆåœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ï¼‰
        async function viewFile(fileId) {
            try {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ iframe æ¥è·å–æ–‡ä»¶å†…å®¹
                const response = await fetch(`/api/documents/${fileId}/view`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${Auth.state.access}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        await Auth.refresh();
                        return viewFile(fileId);
                    }
                    throw new Error(`æŸ¥çœ‹å¤±è´¥: ${response.statusText}`);
                }

                // åˆ›å»º blob URL å¹¶åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const newWindow = window.open(url, '_blank');
                
                // æ¸…ç† URLï¼ˆå¯é€‰ï¼Œä½†å»ºè®®åœ¨æ–°çª—å£å…³é—­åæ¸…ç†ï¼‰
                if (newWindow) {
                    newWindow.addEventListener('beforeunload', () => {
                        window.URL.revokeObjectURL(url);
                    });
                }
            } catch (err) {
                console.error('æ–‡ä»¶æŸ¥çœ‹å¤±è´¥:', err);
                alert(`æŸ¥çœ‹å¤±è´¥ï¼š${err.message}`);
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(fileId) {
            try {
                const response = await fetch(`/api/documents/${fileId}/download`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${Auth.state.access}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        await Auth.refresh();
                        return downloadFile(fileId);
                    }
                    throw new Error(`ä¸‹è½½å¤±è´¥: ${response.statusText}`);
                }

                // è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'download';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error('æ–‡ä»¶ä¸‹è½½å¤±è´¥:', err);
                alert(`ä¸‹è½½å¤±è´¥ï¼š${err.message}`);
            }
        }

        // é‡å‘½åæ–‡ä»¶
        async function renameFile(fileId, currentName) {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶å:', currentName);
            if (!newName || newName.trim() === '') return;

            try {
                const response = await fetch(`/api/documents/${fileId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${Auth.state.access}`
                    },
                    body: JSON.stringify({
                        name: newName.trim()
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        await Auth.refresh();
                        return renameFile(fileId, currentName);
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || response.statusText);
                }

                const result = await response.json();
                console.log('æ–‡ä»¶é‡å‘½åæˆåŠŸ:', result);
                alert('é‡å‘½åæˆåŠŸ');
                await loadFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            } catch (err) {
                console.error('æ–‡ä»¶é‡å‘½åå¤±è´¥:', err);
                alert(`é‡å‘½åå¤±è´¥ï¼š${err.message}`);
            }
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(fileId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

            try {
                const response = await fetch(`/api/documents/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${Auth.state.access}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        await Auth.refresh();
                        return deleteFile(fileId);
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || response.statusText);
                }

                const result = await response.json();
                console.log('æ–‡ä»¶åˆ é™¤æˆåŠŸ:', result);
                alert('åˆ é™¤æˆåŠŸ');
                await loadFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            } catch (err) {
                console.error('æ–‡ä»¶åˆ é™¤å¤±è´¥:', err);
                alert(`åˆ é™¤å¤±è´¥ï¼š${err.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç”¨æˆ·èµ„æ–™å’Œæ–‡ä»¶åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await loadFiles();
        });

        // ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        document.getElementById('file-input').addEventListener('change', uploadFiles);
    </script>
</body>
</html>
